---
import { getCollection } from "astro:content";
import Layout from "@layouts/Layout.astro";
import Header from "@components/Header.astro";
import Footer from "@components/Footer.astro";
import LinkButton from "@components/LinkButton.astro";
import Hr from "@components/Hr.astro";
import Card from "@components/Card";
import { getSortedPosts } from "@utils/getSortedPosts";
import getPostsWithEnrichedFrontmatter from "@utils/getPostsWithEnrichedFrontmatter";
import { SITE } from "@config";

// Load all collections
const baseNotes = await getCollection("notes", ({ data }) => data.status && data.status === "published");
const notes = await getPostsWithEnrichedFrontmatter<"notes">(baseNotes);
const sortedNotes = getSortedPosts(notes);

const baseWriting = await getCollection("writing", ({ data }) => data.status && data.status === "published");
const writing = await getPostsWithEnrichedFrontmatter<"writing">(baseWriting);
const sortedWriting = getSortedPosts(writing);

const baseLife = await getCollection("life", ({ data }) => data.status && data.status === "published");
const life = await getPostsWithEnrichedFrontmatter<"life">(baseLife);
const sortedLife = getSortedPosts(life);

// Get recent items from each section
const recentNotes = sortedNotes.slice(0, SITE.postPerIndex);
const recentWriting = sortedWriting.slice(0, SITE.postPerIndex);
const recentLife = sortedLife.slice(0, SITE.postPerIndex);

---

<Layout>
  <Header />
  <main id="main-content">
    <section id="hero">
      <h1 class="mr-2"><span class="text-skin-accent">Daniel</span> van der Merwe</h1>
      <h2>Technical Director. Builder. Systems Thinker.</h2>
      <p>
        I co-run Rokkit200 with my business partner, where we ship Optimizely CMS work for real clients. Outside of that, I'm always iterating on systems that help me think clearly, stay focused, and show up properly for the people and commitments in my life.
      </p>
      <p>
        This site is my home base for practical notes on mindful productivity, tools for thought, and software patterns. You'll find experiments I'm running, frameworks I'm refining, and patterns I use across work and personal life.
      </p>
    </section>

    {
      recentWriting.length > 0 && (
        <>
          <section class="featured" id="writing">
            <h2>Recent Writing</h2>
            <ul>
              {recentWriting.map(({ data, id }) => (
                <Card
                  href={`/writing/${id}/`}
                  frontmatter={data}
                  secHeading={false}
                  showNexusScore={true}
                />
              ))}
            </ul>
          </section>
          <div class="all-posts-btn-wrapper">
            <LinkButton href="/writing">
              All Writing
              <svg xmlns="http://www.w3.org/2000/svg"
                ><path
                  d="m11.293 17.293 1.414 1.414L19.414 12l-6.707-6.707-1.414 1.414L15.586 11H6v2h9.586z"
                ></path>
              </svg>
            </LinkButton>
          </div>
          <Hr />
        </>
      )
    }

    {
      recentNotes.length > 0 && (
        <>
          <section class="featured" id="notes">
            <h2>Recent Notes</h2>
            <ul>
              {recentNotes.map(({ data, id }) => (
                <Card
                  href={`/notes/${id}/`}
                  frontmatter={data}
                  secHeading={false}
                  showNexusScore={true}
                />
              ))}
            </ul>
          </section>
          <div class="all-posts-btn-wrapper">
            <LinkButton href="/notes">
              All Notes
              <svg xmlns="http://www.w3.org/2000/svg"
                ><path
                  d="m11.293 17.293 1.414 1.414L19.414 12l-6.707-6.707-1.414 1.414L15.586 11H6v2h9.586z"
                ></path>
              </svg>
            </LinkButton>
          </div>
          <Hr />
        </>
      )
    }

    {
      recentLife.length > 0 && (
        <>
          <section class="featured" id="life">
            <h2>Recent Life</h2>
            <ul>
              {recentLife.map(({ data, id }) => (
                <Card
                  href={`/life/${id}/`}
                  frontmatter={data}
                  secHeading={false}
                  showNexusScore={true}
                />
              ))}
            </ul>
          </section>
          <div class="all-posts-btn-wrapper">
            <LinkButton href="/life">
              All Life
              <svg xmlns="http://www.w3.org/2000/svg"
                ><path
                  d="m11.293 17.293 1.414 1.414L19.414 12l-6.707-6.707-1.414 1.414L15.586 11H6v2h9.586z"
                ></path>
              </svg>
            </LinkButton>
          </div>
        </>
      )
    }
  </main>

  <Footer />
</Layout>

<style>
  /* ===== Hero Section ===== */
  #hero {
    @apply pb-6 pt-8;
  }
  #hero h1 {
    @apply my-4 inline-block text-3xl font-bold sm:my-8 sm:text-6xl;
  }
  #hero h2 {
    @apply my-4 inline-block text-xl sm:my-4 sm:text-2xl;
  }
  #hero .rss-link {
    @apply mb-6;
  }
  #hero .rss-icon {
    @apply mb-2 h-6 w-6 scale-110 fill-skin-accent sm:mb-3 sm:scale-125;
  }
  #hero p {
    @apply my-2;
  }
  .social-wrapper {
    @apply mt-4 flex flex-col sm:flex-row sm:items-center;
  }
  .social-links {
    @apply mb-1 mr-2 whitespace-nowrap sm:mb-0;
  }

  /* ===== Featured & Recent Posts Sections ===== */
  .featured {
    @apply pb-6 pt-12;
  }
  .featured h2 {
    @apply text-3xl font-semibold tracking-wide;
  }
  .all-posts-btn-wrapper {
    @apply my-8 text-center;
  }

  /* ===== Fragment Posts Grid ===== */
  .fragment-grid {
    @apply grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-2;
  }
</style>
