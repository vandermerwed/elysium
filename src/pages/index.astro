---
import { getCollection } from "astro:content";
import Layout from "@layouts/Layout.astro";
import Header from "@components/Header.astro";
import Footer from "@components/Footer.astro";
import SectionHeader from "@components/SectionHeader.astro";
import CyclingWords from "@components/CyclingWords.astro";
import WritingCard from "@components/WritingCard.astro";
import JournalCard from "@components/JournalCard.astro";
import NoteCard from "@components/NoteCard.astro";
import ExplorationCard from "@components/ExplorationCard.astro";
import ProjectCard from "@components/ProjectCard.astro";
import { getSortedProjects } from "@utils/getSortedProjects";
import { getSortedPosts } from "@utils/getSortedPosts";
import getPostsWithEnrichedFrontmatter from "@utils/getPostsWithEnrichedFrontmatter";
import { buildNoteGraph } from "@utils/noteGraph";
import { SITE } from "@config";

const allNotes = await getCollection("notes");
const allWriting = await getCollection("writing");
const allJournal = await getCollection("journal");
const allProjects = await getCollection("projects");
const graph = buildNoteGraph([...allNotes, ...allWriting, ...allJournal, ...allProjects]);

const baseNotes = allNotes.filter(({ data }) => data.status && (data.status === "published" || data.status === "release"));
const notes = await getPostsWithEnrichedFrontmatter<"notes">(baseNotes, graph);
const sortedNotes = getSortedPosts(notes);

const baseWriting = allWriting.filter(({ data }) => data.status && (data.status === "published" || data.status === "release"));
const writing = await getPostsWithEnrichedFrontmatter<"writing">(baseWriting, graph);
const sortedWriting = getSortedPosts(writing);

const baseJournal = allJournal.filter(({ data }) => data.status && (data.status === "published" || data.status === "release"));
const journal = await getPostsWithEnrichedFrontmatter<"journal">(baseJournal, graph);
const sortedJournal = getSortedPosts(journal);

const projects = getSortedProjects(allProjects);

const latestWriting = sortedWriting.slice(0, SITE.postPerIndex);
const latestJournal = sortedJournal.slice(0, SITE.postPerIndex);
const latestNotes = sortedNotes.filter(n => !("type" in n.data && n.data.type === "exploration")).slice(0, SITE.postPerIndex);
const recentExplorations = getSortedPosts(notes, ["exploration"]).slice(0, 4);
const recentProjects = projects.filter(p => p.data.status !== "archived").slice(0, 3);

---

<Layout>
  <Header />
  <main id="main-content">
    <section id="hero">
      <h1 class="hero-name">
        <span class="hero-first"><span class="hero-prompt" aria-hidden="true">&gt;</span>Daniel</span>
        <span class="hero-surname">van der Merwe</span>
      </h1>
      <h2 class="hero-cycling">
        <CyclingWords
          words={[
            ["thinks", "in systems"],
            ["automates", "the boring"],
            ["builds", "for others"],
            ["tinkers", "relentlessly"],
            ["writes", "to think"],
            ["learns", "in public"],
            ["cares", "about craft"],
            ["cares", "about people"],
            ["shows", "up"],
          ]}
          style="scramble"
        />
      </h2>
      <span class="hero-rule" aria-hidden="true"></span>
    </section>

    {
      latestWriting.length > 0 && (
        <section class="home-section" id="latest-writing">
          <SectionHeader title="Writing" href="/writing/" linkLabel="All" />
          <ul>
            {latestWriting.map(({ data, id }) => (
              <WritingCard
                href={`/writing/${id}/`}
                title={data.title}
                pubDatetime={data.pubDatetime}
                modDatetime={data.modDatetime}
                description={data.description}
                wordCount={data.wordCount}
                readingTime={data.readingTime}
              />
            ))}
          </ul>
        </section>
      )
    }

    {
      latestJournal.length > 0 && (
        <section class="home-section" id="latest-journal">
          <SectionHeader title="Journal" href="/journal/" linkLabel="All" />
          <ul>
            {latestJournal.map(({ data, id }) => (
              <JournalCard
                href={`/journal/${id}/`}
                title={data.title}
                pubDatetime={data.pubDatetime}
                modDatetime={data.modDatetime}
                description={data.description}
                wordCount={data.wordCount}
                readingTime={data.readingTime}
                type={"type" in data ? (data as Record<string, unknown>).type as string | undefined : undefined}
              />
            ))}
          </ul>
        </section>
      )
    }

    {
      latestNotes.length > 0 && (
        <section class="home-section" id="latest-notes">
          <SectionHeader title="Notes" href="/notes/" linkLabel="All" />
          <ul>
            {latestNotes.map(({ data, id }) => (
              <NoteCard
                href={`/notes/${id}/`}
                title={data.title}
                pubDatetime={data.pubDatetime}
                description={data.description}
                nexusScore={data.nexusScore}
                type={"type" in data ? (data as Record<string, unknown>).type as string | undefined : undefined}
                contentType="notes"
              />
            ))}
          </ul>
        </section>
      )
    }

    {
      recentExplorations.length > 0 && (
        <section class="home-section" id="recent-explorations">
          <SectionHeader title="Explorations" href="/notes/?type=exploration" linkLabel="All" />
          <ul class="fragment-grid">
            {recentExplorations.map(({ data, id }) => (
              <ExplorationCard
                href={`/notes/${id}/`}
                title={data.title}
                description={data.description}
                prototypeUrl={data.prototypeUrl}
                prototypeType={data.prototypeType}
              />
            ))}
          </ul>
        </section>
      )
    }

    {
      recentProjects.length > 0 && (
        <section class="home-section" id="recent-projects">
          <SectionHeader title="Projects" href="/projects/" linkLabel="All" />
          <ul>
            {recentProjects.map(({ data, id }) => (
              <ProjectCard
                href={`/projects/${id}/`}
                title={data.title}
                description={data.description}
                status={data.status}
                techStack={data.techStack}
                startDate={data.startDate}
              />
            ))}
          </ul>
        </section>
      )
    }
  </main>

  <Footer />
</Layout>

<style>
  /* ===== Hero Section ===== */
  #hero {
    @apply pb-6 pt-8;
  }
  .hero-name {
    @apply font-mono font-normal;
    color: rgb(var(--color-text-base));
    line-height: 1.1;
    text-transform: uppercase;
  }
  .hero-first {
    @apply block text-4xl sm:text-5xl;
    display: flex;
    align-items: baseline;
  }
  .hero-prompt {
    color: rgb(var(--color-accent));
    margin-right: 0.35ch;
    font-weight: 400;
  }
  .hero-surname {
    @apply block text-xl sm:text-2xl;
    color: rgb(var(--color-text-base) / 0.5);
    letter-spacing: 0.15em;
    margin-top: 0.15em;
  }
  .hero-cycling {
    @apply mt-3 block text-xl sm:text-2xl;
    color: rgb(var(--color-text-base));
    text-transform: uppercase;
  }
  .hero-rule {
    @apply mt-6 block;
    width: 6ch;
    border-bottom: 1px solid rgb(var(--color-border));
  }

  /* ===== Sections ===== */
  .home-section {
    @apply pb-4 pt-10;
  }
  .home-section ul {
    @apply mt-4;
  }

  /* ===== Fragment Posts Grid ===== */
  .fragment-grid {
    @apply grid grid-cols-1 gap-4 sm:grid-cols-2;
  }
</style>
