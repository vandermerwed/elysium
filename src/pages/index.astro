---
import Layout from "@layouts/Layout.astro";
import Header from "@components/Header.astro";
import Footer from "@components/Footer.astro";
import SectionHeader from "@components/SectionHeader.astro";
import CyclingWords from "@components/CyclingWords.astro";
import WritingCard from "@components/WritingCard.astro";
import JournalCard from "@components/JournalCard.astro";
import NoteCard from "@components/NoteCard.astro";
import ExplorationCard from "@components/ExplorationCard.astro";
import ProjectCard from "@components/ProjectCard.astro";
import { getSortedProjects } from "@utils/getSortedProjects";
import { getSortedPosts } from "@utils/getSortedPosts";
import { getSortedNotes } from "@utils/getSortedNotes";
import getPostsWithEnrichedFrontmatter from "@utils/getPostsWithEnrichedFrontmatter";
import { getSharedGraph, getCollections } from "@utils/buildGraph";
import { getSeqNum } from "@utils/marginalia";
import { SITE } from "@config";

const collections = await getCollections();
const graph = await getSharedGraph();

const baseNotes = collections.notes.filter(({ data }) => data.status && (data.status === "published" || data.status === "release"));
const notes = await getPostsWithEnrichedFrontmatter<"notes">(baseNotes, graph);
const sortedNotes = getSortedNotes(notes);

const baseWriting = collections.writing.filter(({ data }) => data.status && (data.status === "published" || data.status === "release"));
const writing = await getPostsWithEnrichedFrontmatter<"writing">(baseWriting, graph);
const sortedWriting = getSortedPosts(writing);

const baseJournal = collections.journal.filter(({ data }) => data.status && (data.status === "published" || data.status === "release"));
const journal = await getPostsWithEnrichedFrontmatter<"journal">(baseJournal, graph);
const sortedJournal = getSortedPosts(journal);

const projects = getSortedProjects(collections.projects);

const latestWriting = sortedWriting.slice(0, SITE.postPerIndex);
const latestJournal = sortedJournal.slice(0, SITE.postPerIndex);
const latestNotes = sortedNotes.filter(n => !("type" in n.data && n.data.type === "exploration")).slice(0, SITE.notesPerIndex);
const recentExplorations = getSortedPosts(notes, ["exploration"]).slice(0, 4);
const recentProjects = projects.filter(p => p.data.status !== "archived").slice(0, 3);

---

<Layout>
  <Header />
  <main id="main-content">
    <section id="hero">
      <h1 class="hero-name">
        <span class="hero-first"><span class="hero-prompt" aria-hidden="true">&gt;</span>Daniel</span>
        <span class="hero-surname">van der Merwe</span>
      </h1>
      <h2 class="hero-cycling">
        <CyclingWords
          words={[
            ["thinks", "in systems"],
            ["automates", "the boring"],
            ["builds", "for others"],
            ["tinkers", "relentlessly"],
            ["writes", "to think"],
            ["learns", "in public"],
            ["cares", "about craft"],
            ["cares", "about people"],
            ["shows", "up"],
          ]}
          style="scramble"
        />
      </h2>
      <span class="hero-rule" aria-hidden="true"></span>
    </section>

    {
      latestWriting.length > 0 && (
        <section class="home-section" id="latest-writing">
          <SectionHeader title="Writing" href="/writing/" linkLabel="All" />
          <ul>
            {latestWriting.map(({ data, id }) => (
              <WritingCard
                href={`/writing/${id}/`}
                title={data.title}
                pubDatetime={data.pubDatetime}
                modDatetime={data.modDatetime}
                description={data.description}
                wordCount={data.wordCount}
                readingTime={data.readingTime}
              />
            ))}
          </ul>
        </section>
      )
    }

    {
      latestJournal.length > 0 && (
        <section class="home-section" id="latest-journal">
          <SectionHeader title="Journal" href="/journal/" linkLabel="All" />
          <ul>
            {latestJournal.map(({ data, id }) => (
              <JournalCard
                href={`/journal/${id}/`}
                title={data.title}
                pubDatetime={data.pubDatetime}
                modDatetime={data.modDatetime}
                description={data.description}
                wordCount={data.wordCount}
                readingTime={data.readingTime}
                type={"type" in data ? (data as Record<string, unknown>).type as string | undefined : undefined}
              />
            ))}
          </ul>
        </section>
      )
    }

    {
      latestNotes.length > 0 && (
        <section class="home-section" id="latest-notes">
          <SectionHeader title="Notes" href="/notes/" linkLabel="All" />
          <ul>
            {latestNotes.map(({ data, id }) => (
              <NoteCard
                href={`/notes/${id}/`}
                title={data.title}
                pubDatetime={data.pubDatetime}
                modDatetime={data.modDatetime}
                description={data.description}
                nexusScore={data.nexusScore}
                type={"type" in data ? (data as Record<string, unknown>).type as string | undefined : undefined}
                contentType="notes"
              />
            ))}
          </ul>
        </section>
      )
    }

    {
      recentExplorations.length > 0 && (
        <section class="home-section" id="recent-explorations">
          <SectionHeader title="Explorations" href="/notes/?type=exploration" linkLabel="All" />
          <ul class="exploration-layout">
            {recentExplorations.map(({ data, id }, index) => (
              <ExplorationCard
                href={`/notes/${id}/`}
                title={data.title}
                description={data.description}
                pubDatetime={data.pubDatetime}
                prototypeUrl={data.prototypeUrl}
                prototypeType={data.prototypeType}
                inspiration={data.inspiration as any}
                seqNum={getSeqNum(index, recentExplorations.length)}
              />
            ))}
          </ul>
        </section>
      )
    }

    {
      recentProjects.length > 0 && (
        <section class="home-section" id="recent-projects">
          <SectionHeader title="Projects" href="/projects/" linkLabel="All" />
          <ul>
            {recentProjects.map(({ data, id }) => (
              <ProjectCard
                href={`/projects/${id}/`}
                title={data.title}
                description={data.description}
                status={data.status}
                techStack={data.techStack}
                startDate={data.startDate}
              />
            ))}
          </ul>
        </section>
      )
    }
  </main>

  <Footer />
</Layout>

<style>
  /* ===== Main ===== */
  #main-content {
    @apply pb-10;
  }

  /* ===== Hero Section ===== */
  #hero {
    @apply pb-6 pt-8;
  }
  .hero-name {
    @apply font-mono font-normal;
    color: rgb(var(--color-text-base));
    line-height: 1.1;
    text-transform: uppercase;
  }
  .hero-first {
    @apply block text-4xl sm:text-5xl;
    display: flex;
    align-items: baseline;
  }
  .hero-prompt {
    color: rgb(var(--color-accent));
    margin-right: 0.35ch;
    font-weight: 400;
  }
  .hero-surname {
    @apply block text-xl sm:text-2xl;
    color: rgb(var(--color-text-base) / 0.5);
    letter-spacing: 0.15em;
    margin-top: 0.15em;
  }
  .hero-cycling {
    @apply mt-3 block text-xl sm:text-2xl;
    color: rgb(var(--color-text-base));
    text-transform: uppercase;
  }
  .hero-rule {
    @apply mt-6 block;
    width: 6ch;
    border-bottom: 1px solid rgb(var(--color-border));
  }

  /* ===== Sections ===== */
  .home-section {
    @apply py-10;
  }
  .home-section ul {
    @apply mt-4;
  }

  /* ===== Fragment Posts Grid ===== */
  .fragment-grid {
    @apply grid grid-cols-1 gap-4 sm:grid-cols-2;
  }

  /* ===== Explorations Layout ===== */
  .exploration-layout {
    @apply grid grid-cols-1 gap-4;
  }
  /* First item full-width featured; 3+ items: rest in 2-col grid */
  @media (min-width: 640px) {
    .exploration-layout {
      grid-template-columns: repeat(2, 1fr);
    }
    .exploration-layout > :global(:first-child) {
      grid-column: 1 / -1;
    }
    /* Single item stays full-width naturally */
  }
</style>
