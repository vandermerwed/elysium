---
export interface Props {
  url: string;
  type: "v0" | "codepen" | "figma" | "custom";
  title?: string;
}

const { url, type, title } = Astro.props;
---

<section class="prototype-embed">
  <div class="prototype-header">
    {title && <h3>{title}</h3>}
    <a href={url} target="_blank" rel="noreferrer" class="prototype-external">
      Open in new tab&nbsp;&nearr;
    </a>
  </div>
  {type === "custom" ? (
    <a href={url} target="_blank" rel="noreferrer" class="prototype-link">
      View Prototype &rarr;
    </a>
  ) : (
    <div class="prototype-frame" data-src={url} data-title={title ?? "Prototype"}>
      <button class="prototype-load" type="button">
        <span class="prototype-load-icon" aria-hidden="true">&#9654;</span>
        Load Prototype
        <span class="prototype-load-hint">Loads external content from {new URL(url).hostname}</span>
      </button>
    </div>
  )}
</section>

<script>
  document.addEventListener("astro:page-load", () => {
    document.querySelectorAll<HTMLDivElement>(".prototype-frame[data-src]").forEach(frame => {
      const btn = frame.querySelector<HTMLButtonElement>(".prototype-load");
      if (!btn) return;
      btn.addEventListener("click", () => {
        const iframe = document.createElement("iframe");
        iframe.src = frame.dataset.src!;
        iframe.title = frame.dataset.title ?? "Prototype";
        iframe.loading = "lazy";
        iframe.allow = "fullscreen; clipboard-write";
        // Inline styles guarantee sizing regardless of specificity
        iframe.style.display = "block";
        iframe.style.width = "100%";
        iframe.style.height = "100%";
        iframe.style.border = "none";
        iframe.style.borderRadius = "0 0 6px 6px";
        frame.replaceChildren(iframe);
      }, { once: true });
    });
  });
</script>

<style>
  .prototype-embed {
    @apply mx-auto my-8 max-w-3xl overflow-hidden rounded-lg;
    border: 1px solid rgb(var(--color-border));
    background: rgb(var(--color-card));
  }
  .prototype-header {
    @apply flex items-center justify-between gap-4 px-4 py-3 font-mono;
    border-bottom: 1px solid rgb(var(--color-border));
  }
  .prototype-header h3 {
    @apply m-0 text-sm font-medium;
    color: rgb(var(--color-text-base));
  }
  .prototype-external {
    @apply whitespace-nowrap text-xs;
    color: rgb(var(--color-base));
    text-decoration: none;
    transition: color var(--transition-base);
  }
  .prototype-external:hover {
    color: rgb(var(--color-accent));
  }
  .prototype-frame {
    position: relative;
    width: 100%;
    height: 32rem;
  }
  .prototype-frame iframe {
    display: block;
    width: 100%;
    height: 100%;
    border: none;
    border-radius: 0 0 6px 6px;
  }
  .prototype-load {
    position: absolute;
    inset: 0;
    display: flex;
    width: 100%;
    cursor: pointer;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    border: none;
    border-radius: 0 0 6px 6px;
    font-family: var(--font-mono);
    font-size: 0.875rem;
    letter-spacing: 0.025em;
    background: rgb(var(--color-card-muted) / 0.3);
    color: rgb(var(--color-base));
    transition: background var(--transition-base), color var(--transition-base);
  }
  .prototype-load:hover {
    background: rgb(var(--color-card-muted) / 0.6);
    color: rgb(var(--color-text-base));
  }
  .prototype-load:hover .prototype-load-icon {
    color: rgb(var(--color-accent));
  }
  .prototype-load-icon {
    font-size: 1.5rem;
    transition: color var(--transition-base);
  }
  .prototype-load-hint {
    font-size: 0.7rem;
    opacity: 0.5;
  }
  .prototype-link {
    @apply block px-4 py-6 text-center font-mono text-sm;
    text-decoration: underline;
    text-decoration-style: dotted;
    text-underline-offset: 4px;
  }
  .prototype-link:hover {
    color: rgb(var(--color-accent));
  }
</style>
