---
import { getCollection } from "astro:content";
import { SOCIALS } from "@config";
import { getGitHash, getVersion, getBuildTimestamp } from "@utils/buildInfo";

const currentYear = new Date().getFullYear();

const publishedFilter = ({ data }: { data: { status?: string } }) =>
  data.status === "published" || data.status === "release";
const projectStatuses = new Set(["active", "stable", "archived"]);

type FooterCounts = {
  noteCount: number;
  writingCount: number;
  projectCount: number;
};

const FOOTER_COUNTS_KEY = "__FOOTER_COUNTS__";
const globalAny = globalThis as typeof globalThis & { [FOOTER_COUNTS_KEY]?: FooterCounts };

if (!globalAny[FOOTER_COUNTS_KEY]) {
  const [notes, writing, projects] = await Promise.all([
    getCollection("notes", publishedFilter),
    getCollection("writing", publishedFilter),
    getCollection("projects", ({ data }) => !data.hidden && projectStatuses.has(data.status ?? "")),
  ]);

  globalAny[FOOTER_COUNTS_KEY] = {
    noteCount: notes.length,
    writingCount: writing.length,
    projectCount: projects.length,
  };
}

const { noteCount, writingCount, projectCount } = globalAny[FOOTER_COUNTS_KEY] as FooterCounts;

const gitHash = getGitHash();
const version = getVersion();
const buildTimestamp = getBuildTimestamp();

const activeSocials = SOCIALS.filter(s => s.active);

export interface Props {
  noMarginTop?: boolean;
}

const { noMarginTop = false } = Astro.props;
---

<footer class={`${noMarginTop ? "" : "mt-auto"}`}>
  <div class="footer-rule">
    <hr aria-hidden="true" />
  </div>
  <div class="footer-wrapper">
    <div class="footer-main">
      <div class="footer-row">
        <span class="footer-copyright">&copy; {currentYear} Daniel van der Merwe</span>
        <nav class="footer-nav" aria-label="Footer navigation">
          <a href="/changelog/">changelog</a>
          <span class="footer-dot" aria-hidden="true">&middot;</span>
          <a href="https://github.com/vandermerwed/elysium" rel="noreferrer">source</a>
          <span class="footer-dot" aria-hidden="true">&middot;</span>
          <a href="/tags/">tags</a>
          <span class="footer-dot" aria-hidden="true">&middot;</span>
          <a href="/rss.xml">rss</a>
        </nav>
      </div>

      <nav class="footer-social" aria-label="Social links">
        {activeSocials.map((social, i) => (
          <>
            <a href={social.href} title={social.linkTitle} rel="noreferrer">{social.name.toLowerCase()}</a>
            {i < activeSocials.length - 1 && <span class="footer-dot" aria-hidden="true">&middot;</span>}
          </>
        ))}
      </nav>
    </div>

    <div class="footer-status">
      <div class="status-line">
        <span class="status-label">SYS</span>
        <span class="status-dots" aria-hidden="true"></span>
        <span class="status-value">{noteCount} notes &middot; {writingCount} articles &middot; {projectCount} projects</span>
      </div>
      <div class="status-line">
        <span class="status-label">BUILD</span>
        <span class="status-dots" aria-hidden="true"></span>
        <span class="status-value">
          {buildTimestamp} &middot; v{version} &middot;{" "}
          {gitHash === "dev"
            ? <>#{gitHash}</>
            : <a href={`https://github.com/vandermerwed/elysium/commit/${gitHash}`} rel="noreferrer">#{gitHash}</a>}
        </span>
      </div>
    </div>
  </div>
</footer>

<style>
  footer {
    @apply w-full;
  }
  .footer-rule {
    @apply mx-auto max-w-3xl px-4;
  }
  .footer-rule hr {
    border-color: rgb(var(--color-border));
    border-top-width: 1px;
  }
  .footer-wrapper {
    @apply mx-auto max-w-3xl space-y-3 px-4 py-6;
  }
  .footer-main {
    @apply space-y-1;
  }
  .footer-row {
    @apply flex flex-wrap items-baseline justify-between gap-x-4 gap-y-1;
  }
  .footer-copyright {
    @apply text-sm;
    color: rgb(var(--color-base));
  }
  .footer-nav {
    @apply flex flex-wrap items-center justify-end gap-x-1 gap-y-0 font-mono text-sm;
  }
  .footer-nav a {
    color: rgb(var(--color-base));
    text-decoration: none;
    transition: color var(--transition-base);
  }
  .footer-nav a:hover {
    color: rgb(var(--color-accent));
  }
  .footer-nav a[rel="noreferrer"]:hover {
    color: rgb(var(--color-accent-secondary));
  }
  .footer-dot {
    color: rgb(var(--color-border-muted));
  }
  .footer-social {
    @apply flex flex-wrap items-center justify-end gap-x-1 gap-y-0 font-mono text-sm;
  }
  .footer-social a {
    color: rgb(var(--color-base));
    text-decoration: none;
    transition: color var(--transition-base);
  }
  .footer-social a:hover {
    color: rgb(var(--color-accent-secondary));
  }

  .footer-status {
    @apply space-y-0 font-mono;
    font-size: 0.65rem;
    line-height: 1.4;
    color: rgb(var(--color-border-muted));
    margin-top: 1rem;
  }
  .status-line {
    @apply flex items-baseline gap-1.5;
  }
  .status-label {
    @apply uppercase;
    font-weight: 400;
    letter-spacing: 0.05em;
    color: rgb(var(--color-border-muted));
  }
  .status-dots {
    @apply flex-1;
    border-bottom: 1px dotted rgb(var(--color-border));
    position: relative;
    top: -3px;
    opacity: 0.4;
  }
  .status-value {
    @apply whitespace-nowrap;
  }
  .status-value a {
    color: rgb(var(--color-border-muted));
    text-decoration: none;
    transition: color var(--transition-base);
  }
  .status-value a:hover {
    color: rgb(var(--color-accent));
  }
</style>
