---
import { formatDate } from "@utils/marginalia";
import NexusScore from "./NexusScore";

export interface Props {
  href: string;
  title: string;
  pubDatetime: Date;
  description: string;
  nexusScore?: string;
  contentHash?: string;
  seqNum?: string;
  type?: string;
  incomingLinks?: number;
  outgoingLinks?: number;
  externalLinks?: number;
  showLinks?: boolean;
  contentType?: string;
}

const {
  href,
  title,
  pubDatetime,
  description,
  nexusScore,
  contentHash,
  seqNum,
  type,
  incomingLinks = 0,
  outgoingLinks = 0,
  externalLinks = 0,
  showLinks = false,
  contentType = "notes",
} = Astro.props;

const nexusScorePattern = /^(?:B|A|R|H|T)_(?:Fragment|Basic|Developed|Advanced|Integrated)$/;
const isValidScore = nexusScore && nexusScorePattern.test(nexusScore);

---

<li class="note-card" data-content-type={contentType}>
  <div class="note-row">
    {isValidScore && (
      <span class="note-nexus">
        <NexusScore score={nexusScore} size="sm" />
      </span>
    )}
    <a href={href} class="note-title" transition:name={href}>
      {title}
    </a>
    <span class="note-dots" aria-hidden="true"></span>
    <span class="note-date">{formatDate(pubDatetime)}</span>
    {seqNum && <span class="note-position">{seqNum}{contentHash && <span class="note-hash">{contentHash}</span>}</span>}
  </div>
  <div class="note-sub">
    <span class="note-desc">{description}</span>
  </div>
  {showLinks && (incomingLinks > 0 || outgoingLinks > 0 || externalLinks > 0) && (
    <div class="note-links" title="incoming ↓ · outgoing ↑ · external ↗">
      {incomingLinks > 0 && <span>{incomingLinks}&#8595;</span>}
      {outgoingLinks > 0 && <span>{outgoingLinks}&#8593;</span>}
      {externalLinks > 0 && <span>{externalLinks}&#8599;</span>}
    </div>
  )}
</li>

<style>
  .note-card {
    @apply my-4;
  }
  .note-row {
    @apply flex items-center gap-2 font-mono text-sm;
  }
  .note-nexus {
    @apply hidden flex-shrink-0 sm:inline-flex;
    /* 3 cells × 7px = 21px square icon */
    width: 21px;
    justify-content: center;
  }
  .note-title {
    @apply whitespace-nowrap font-medium;
    color: rgb(var(--color-text-base));
    text-decoration: none;
    transition: color var(--transition-base);
  }
  .note-title:hover {
    color: rgb(var(--color-accent));
    text-decoration: none;
  }
  .note-dots {
    @apply flex-1;
    border-bottom: 1px dotted rgb(var(--color-border-muted));
    position: relative;
    top: -3px;
  }
  .note-date {
    @apply whitespace-nowrap;
    color: rgb(var(--color-base));
  }
  .note-position {
    @apply hidden whitespace-nowrap sm:inline;
    color: rgb(var(--color-base));
    opacity: 0.6;
  }
  .note-hash {
    @apply ml-1;
    opacity: 0.5;
  }
  .note-type {
    @apply hidden whitespace-nowrap text-xs uppercase sm:inline;
    color: rgb(var(--color-base));
  }
  .note-sub {
    @apply mt-1 overflow-hidden text-xs;
    color: rgb(var(--color-base));
  }
  @media (min-width: 640px) {
    .note-sub {
      /* icon 21px + gap 8px = 29px, aligns with title start */
      padding-left: 29px;
    }
  }
  .note-desc {
    @apply block truncate;
  }
  .note-links {
    @apply mt-0.5 hidden gap-1.5 font-mono text-xs sm:flex;
    padding-left: 29px;
    color: rgb(var(--color-base));
    opacity: 0.7;
  }
</style>
