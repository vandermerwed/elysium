---
import Layout from "@layouts/Layout.astro";
import Main from "@layouts/Main.astro";
import Header from "@components/Header.astro";
import Footer from "@components/Footer.astro";
import ProjectCard from "@components/ProjectCard.astro";
import { SITE } from "@config";
import type { Page } from "astro";
import type { CollectionEntry } from "astro:content";

export interface Props {
  page: Page<CollectionEntry<"projects">>;
}

const { page } = Astro.props;

const groupedProjects = page.data.reduce(
  (acc, project) => {
    const status = project.data.status ?? "active";
    acc[status]?.push(project);
    return acc;
  },
  {
    active: [] as CollectionEntry<"projects">[],
    stable: [] as CollectionEntry<"projects">[],
    archived: [] as CollectionEntry<"projects">[],
  }
);

const statusOrder: Array<keyof typeof groupedProjects> = [
  "active",
  "stable",
  "archived",
];

const sections = statusOrder
  .map((status) => ({
    status,
    projects: groupedProjects[status],
  }))
  .filter((section) => section.projects.length > 0);
---

<Layout title={`Projects | ${SITE.title}`}>
  <Header activeNav="projects" />
  <Main pageTitle="Projects" pageDesc="Selected work across tools, writing, and experiments." count={page.total}>
    <p class="text-sm text-skin-base/80 not-italic">
      I collect a lot of ideas and half-formed experiments. Most stay in the
      notebook, but some make it into the world. This page is where
      I keep track of those outcomes. What shipped, what's steady, and what's now
      on the shelf.
    </p>
    {sections.map(({ status, projects }) => (
      <section class="project-section">
        <div class="status-header">
          <span class="status-label">{status}</span>
          <span class="status-rule" aria-hidden="true"></span>
          <span class="status-count">[{projects.length}]</span>
        </div>
        <ul class="project-list">
          {projects.map(({ data: projectData, id }) => (
            <ProjectCard
              href={`/projects/${id}/`}
              title={projectData.title}
              description={projectData.description}
              status={status}
              techStack={projectData.techStack}
              startDate={projectData.startDate}
            />
          ))}
        </ul>
      </section>
    ))}
  </Main>

  <Footer noMarginTop={page.lastPage > 1} />
</Layout>

<style>
  .project-section {
    @apply mt-8;
  }
  .status-header {
    @apply flex items-baseline gap-2 font-mono text-xs uppercase tracking-wide;
    color: rgb(var(--color-base));
  }
  .status-label {
    @apply whitespace-nowrap;
  }
  .status-rule {
    @apply flex-1;
    border-bottom: 1px dotted rgb(var(--color-border-muted));
    position: relative;
    top: -3px;
  }
  .status-count {
    @apply whitespace-nowrap;
  }
  .project-list {
    @apply mt-2;
    list-style: none;
    padding: 0;
  }
</style>
